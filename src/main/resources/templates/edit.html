<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Edit Key</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" th:src="@{/css/styles.css}" />
</head>
<body class="bg-light">
<div class="container py-5" >


    <form  method="post" th:action="@{/edit}" th:object="${keyDto}">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
            <h2 class="mb-0" th:text="'Edit Key - Serial #' + *{serialNumber}"></h2>
        </div>
        <div class="mb-3">
            <label class="form-label">Serial Number</label>
            <input type="text" class="form-control" th:field="*{serialNumber}" id="serialNumber" readonly />
        </div>
        <div class="mb-3">
            <label class="form-label">Status</label>
            <div th:replace="~{fragments/general.html :: statuses (field='status')}"></div>
        </div>

        <div class="mb-3">
            <label for="updatedBy" class="form-label">Last Updated By</label>
            <input type="text" class="form-control" th:field="*{updatedBy}" id="updatedBy" name="actionedBy" required />
        </div>

        <div class="mb-3 d-none" id="signature-container">
            <label class="form-label">Signature</label>
            <canvas id="signature-pad"></canvas>
            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="clear-signature">Clear</button>
        </div>

        <input type="hidden" th:field="*{signatureData}" id="signatureData">

        <button type="submit" class="btn btn-primary">Save</button>
        <a th:href="@{/}" class="btn btn-secondary ms-2">Cancel</a>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const statusField = document.getElementById("status");
    const signatureContainer = document.getElementById("signature-container");
    const form = document.querySelector("form"); // Get the form element

    if (statusField && signatureContainer) {
        statusField.addEventListener("change", () => {
            const isIssued = statusField.value === "issued";
            signatureContainer.classList.toggle("d-none", !isIssued);
            if (!isIssued) {
                // If not "issued", clear the canvas and hidden field
                const canvas = document.getElementById("signature-pad");
                if (canvas) {
                    canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
                }
                document.getElementById("signatureData").value = "";
            }
        });
        statusField.dispatchEvent(new Event("change"));
    }

    // Signature pad logic (edit.html only)
    const canvas = document.getElementById("signature-pad");
    const signatureDataInput = document.getElementById("signatureData");

    if (canvas) {
        const ctx = canvas.getContext("2d");
        let drawing = false;

        // Corrected drawing logic to prevent lines between strokes
        canvas.addEventListener("mousedown", (e) => {
            drawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        });

        canvas.addEventListener("mouseup", () => (drawing = false));
        canvas.addEventListener("mouseleave", () => (drawing = false));

        canvas.addEventListener("mousemove", (e) => {
            if (!drawing) return;
            ctx.lineWidth = 2;
            ctx.lineCap = "round";
            ctx.strokeStyle = "#000";
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
        });

        const clearBtn = document.getElementById("clear-signature");
        clearBtn?.addEventListener("click", () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            signatureDataInput.value = ""; // Also clear the hidden field
        });
    }

    // New logic to handle form submission
    if (form && canvas && signatureDataInput) {
        form.addEventListener("submit", (e) => {
            // Only capture signature if the status is "issued"
            if (statusField.value === "issued") {
                // Get the canvas content as a data URL
                const signatureData = canvas.toDataURL();
                // Set the value of the hidden input
                signatureDataInput.value = signatureData;
            } else {
                // Ensure the hidden field is empty if signature isn't needed
                signatureDataInput.value = "";
            }
        });
    }
</script>
</body>
</html>
